# Nginx configuration for Quarto Review Extension with OAuth2-proxy in Istio
# This configuration injects OAuth2-proxy authentication headers into the HTML
# so that browser JavaScript can access authenticated user information.

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    server {
        listen 80 default_server;
        listen [::]:80 default_server;

        server_name _;

        # Set root directory to nginx html folder
        root /usr/share/nginx/html;
        index index.html;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval';" always;

        # Logging: uncomment to debug OAuth2-proxy header forwarding
        # add_header Debug-User $http_x_auth_request_user always;
        # add_header Debug-Email $http_x_auth_request_email always;
        # add_header Debug-Username $http_x_auth_request_preferred_username always;

        # HTML files: inject OAuth2-proxy auth headers
        location ~* \.html$ {
            # Enable sub_filter for HTML responses
            sub_filter_types text/html;

            # Inject meta tags into HTML head with OAuth2-proxy headers
            # These headers come from Istio's oauth2-proxy extension provider
            sub_filter '<head>' '<head>
    <meta name="x-auth-request-user" content="$http_x_auth_request_user" />
    <meta name="x-auth-request-email" content="$http_x_auth_request_email" />
    <meta name="x-auth-request-preferred-username" content="$http_x_auth_request_preferred_username" />
    <script>
      // Expose OAuth2-proxy headers to browser JavaScript
      window.__authHeaders = {
        "x-auth-request-user": "$http_x_auth_request_user",
        "x-auth-request-email": "$http_x_auth_request_email",
        "x-auth-request-preferred-username": "$http_x_auth_request_preferred_username"
      };
      console.log("[nginx] OAuth2-proxy headers injected:", window.__authHeaders);
    </script>';

            sub_filter_once on;

            # Don't cache HTML files so auth state is always fresh
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
            add_header Pragma "no-cache";
        }

        # JavaScript files: cache for performance
        location ~* \.js$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # CSS files: cache for performance
        location ~* \.css$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Static assets: cache for performance
        location ~* \.(jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Favicon - don't log 404s for favicon
        location = /favicon.ico {
            try_files $uri =204;
            access_log off;
        }

        # Default: serve files, fall back to index.html for SPA routing
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Health check endpoint for Kubernetes/Istio
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
